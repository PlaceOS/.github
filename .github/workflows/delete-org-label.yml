# Deletes a label across all repos in the current organisation.
name: Delete Org Label

on:
  workflow_dispatch:
    inputs:
      label:
        description: 'Name of label to remove'
        required: true

jobs:
  delete-label:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v3
        with:
          github-token: ${{secrets.ACTIONS_PAT}}
          script: |
            const label = context.payload.inputs.label;

            const inUse = async repo => {
              const issues = await github.issues.listForRepo({...repo, labels: label});
              return issues.data.length > 0;
            }

            const deleteLabel = async repo => {
              if (await inUse(repo)) { throw `Label in use in ${repo.repo}` }
              try {
                await github.issues.deleteLabel({...repo, name: label});
                core.info(`Dropped \`${label}\` from ${repo.repo}`);
              } catch (e) {
                if (e.status != 404) { throw e }
                core.info(`Skipped ${repo.repo} - label does not exist`)
              }
            };

            for await (const response of github.paginate.iterator(
              github.repos.listForOrg,
              { org: context.repo.owner }
            )) {
              for (const repo of response.data) {
                await core.group(repo.name, () => deleteLabel({
                  owner: repo.owner.login,
                  repo: repo.name
                }).catch(core.setFailed));
              };
            };
